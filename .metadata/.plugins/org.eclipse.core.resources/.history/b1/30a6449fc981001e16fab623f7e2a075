import java.awt.Color;
import java.awt.Font;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.awt.event.MouseListener;
import java.io.BufferedReader;
import java.io.BufferedWriter;
import java.io.IOException;

import javax.swing.ImageIcon;
import javax.swing.JLabel;



public class ClientRoom extends JLabel{
	
	BufferedReader in;
	private int roomIndex;
	
	private ImageIcon waitRoom = new ImageIcon("./LobbyImages/waitRoom.png"); //배경화면
	private boolean isCreated = false;
	ServerReceiver receiver;
			
	public ClientRoom(ImageIcon roomImage, int idx, BufferedReader in, BufferedWriter out, String userName, String userId) {
		super(roomImage);

		this.roomIndex = idx;
		this.in = in;
		
		setSize(roomImage.getIconWidth(),roomImage.getIconHeight());
		
		if(idx==0) setLocation(20+roomImage.getIconWidth()*0,40+roomImage.getIconHeight()*0);
		if(idx==1) setLocation(20+roomImage.getIconWidth()*1,40+roomImage.getIconHeight()*0);
		if(idx==2) setLocation(20+roomImage.getIconWidth()*0,40+roomImage.getIconHeight()*1);
		if(idx==3) setLocation(20+roomImage.getIconWidth()*1,40+roomImage.getIconHeight()*1);
		if(idx==4) setLocation(20+roomImage.getIconWidth()*0,40+roomImage.getIconHeight()*2);
		if(idx==5) setLocation(20+roomImage.getIconWidth()*1,40+roomImage.getIconHeight()*2);
		
		synchronized(this) {
			receiver = new ServerReceiver();
			receiver.start();
		}

		addMouseListener(new MouseAdapter(){ // 액션 이벤트 처리	
			@Override
			public void mouseClicked(MouseEvent e) {
				// 빈 방 클릭시
				if(!isCreated) {
					isCreated=true;
					try {
						out.write("3/"+userId+"/"+userName+"/"+roomIndex+"\n");
						out.flush();
					} catch (IOException e1) {
						// TODO Auto-generated catch block
						e1.printStackTrace();
					}
				} 
				// 이미 만들어져있는 방 클릭시
				else {
					try {
						out.write("4/"+userId+"/"+userName+"/"+idx+"\n");
						out.flush();
					} catch (IOException e1) {
						// TODO Auto-generated catch block
						e1.printStackTrace();
					}
				}
	
			}
		});
	}
	
	// 방 칠하기
	private void roomCreate(String userName) {
		this.setIcon(waitRoom);
		JLabel roomTitle = new JLabel(userName+" 님의 방");
		roomTitle.setFont(new Font("Serif",Font.BOLD,11));
		roomTitle.setForeground(Color.WHITE);
		roomTitle.setSize(200,50);
		roomTitle.setLocation(100,8);
		add(roomTitle);
		repaint();
	}

	
	
	// 서버로부터 메세지를 받아옴
	public class ServerReceiver extends Thread {
		@Override
		public void run() {
			String msg = null;
			while (true) {
				try {
					msg = in.readLine();
				} catch (Exception e) {
					break;
				}

				int msgType = Integer.parseInt(msg.split("/")[0]);
				String userId = msg.split("/")[1];
				String userName = msg.split("/")[2];
				String msgContent = msg.split("/")[3];
				
				System.out.println(msgContent);
				
				switch(msgType) {
				case 3: // 플레이어가 방 생성시
					roomCreate(userName);
					break;
				default:
					break;
				}
			}

		}
	}
	
}
